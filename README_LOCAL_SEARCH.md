# 本地搜索服务使用说明

## 概述

项目现已支持完全本地化的网络搜索服务，可以替代 Tavily 和 Bocha API，实现不依赖外部 API 的搜索功能。

## 功能特性

### ✅ 已实现的功能

1. **多种搜索引擎支持**
   - DuckDuckGo（默认，免费，无需API Key）
   - Bing（备用引擎，自动回退）

2. **完整的搜索功能**
   - 基础搜索
   - 深度搜索
   - 24小时/1周时间范围搜索
   - 精确日期范围搜索
   - 日期筛选和过滤

3. **智能内容提取**
   - 自动提取网页标题、URL、内容摘要
   - 尝试提取发布日期（从meta标签和HTML内容）
   - HTML内容清理和文本提取

4. **接口兼容性**
   - 完全兼容原有 Tavily/Bocha API 接口
   - 无需修改 Agent 代码
   - 自动回退机制

## 使用方法

### 1. 安装依赖

确保已安装以下依赖（通常已在 requirements.txt 中）：
```bash
pip install requests beautifulsoup4 lxml
```

### 2. 配置（可选）

本地搜索**不需要任何 API Key**，系统会自动使用本地搜索服务。

如果仍想使用 Tavily/Bocha API，可以在 `config.py` 中配置相应的 API Key，系统会优先使用本地搜索。

### 3. 自动启用

系统会**自动检测并使用本地搜索**，无需手动配置。

查看日志输出，如果看到：
```
搜索工具集: 本地搜索服务 (支持6种搜索工具)
```
说明已成功启用本地搜索。

## 架构说明

### 文件结构

```
utils/
└── web_search.py              # 通用搜索引擎实现

QueryEngine/tools/
└── local_search.py            # QueryEngine本地搜索适配器

MediaEngine/tools/
└── local_search.py            # MediaEngine本地搜索适配器
```

### 工作流程

1. **导入检测**：`tools/__init__.py` 优先尝试导入本地搜索模块
2. **接口兼容**：本地搜索类使用别名，保持与原有API相同的接口
3. **自动回退**：如果本地搜索不可用，自动回退到原API（向后兼容）

## 技术细节

### 搜索引擎实现

- **DuckDuckGo**：使用HTML接口，无需API Key
- **Bing**：使用网页搜索接口，作为备用引擎

### 日期提取策略

1. 优先从 HTML meta 标签提取（`article:published_time`）
2. 从 `<time>` 标签提取
3. 从网页文本中正则匹配日期模式
4. 支持多种日期格式转换

### 性能优化

- 请求延迟控制（避免被限流）
- 结果缓存和去重
- 批量处理优化
- 优雅的错误处理和重试

## 局限性

### ⚠️ 当前限制

1. **图片搜索**：暂不支持图片搜索功能（返回空列表）
2. **AI摘要**：不提供AI生成的答案摘要
3. **模态卡**：不支持结构化数据卡片（天气、股票等）
4. **追问建议**：不生成AI追问建议
5. **发布日期**：部分网页可能无法提取发布日期

### 与API服务的对比

| 功能 | 本地搜索 | Tavily API | Bocha API |
|------|---------|------------|-----------|
| 基础网页搜索 | ✅ | ✅ | ✅ |
| 日期范围搜索 | ✅ | ✅ | ⚠️ |
| 图片搜索 | ❌ | ✅ | ✅ |
| AI摘要 | ❌ | ✅ | ✅ |
| 模态卡 | ❌ | ❌ | ✅ |
| 发布日期 | ⚠️ | ✅ | ⚠️ |
| API Key需求 | ❌ | ✅ | ✅ |
| 成本 | 免费 | 付费 | 付费 |

## 故障排查

### 问题1：导入失败

**错误**：`ModuleNotFoundError: No module named 'utils.web_search'`

**解决**：确保 `utils/web_search.py` 文件存在，并检查 Python 路径配置。

### 问题2：搜索结果为空

**可能原因**：
- 网络连接问题
- 搜索引擎返回格式变化
- 被目标网站限流

**解决**：
- 检查网络连接
- 查看日志输出的详细错误信息
- 尝试使用备用搜索引擎（Bing）

### 问题3：日期提取不准确

**说明**：日期提取依赖网页的HTML结构，部分网站可能无法准确提取。

**影响**：时间范围筛选可能不够精确，但不会影响基本搜索功能。

## 未来改进

- [ ] 支持更多搜索引擎（Google、百度等）
- [ ] 添加图片搜索功能
- [ ] 集成AI摘要生成（使用本地LLM）
- [ ] 支持结构化数据提取
- [ ] 改进日期提取准确度
- [ ] 添加搜索缓存机制

## 注意事项

1. **合规性**：请遵守目标网站的 robots.txt 和使用条款
2. **速率限制**：避免过于频繁的请求，已内置延迟控制
3. **网络稳定性**：依赖网络连接，确保网络畅通
4. **反爬虫**：部分网站可能有反爬虫措施，可能导致某些搜索结果无法获取

## 总结

本地搜索服务已完全集成到项目中，**默认启用**，无需额外配置。系统会自动处理搜索请求，完全替代外部API依赖，实现真正的本地化运行。

